name: CI
on:
  push:
  pull_request:

jobs:
  check_format:
    name: Check Format
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - run: ./travis.sh
        env:
          CHECK_CLANG_FORMAT: 1
  build:
    name: Build (${{ matrix.os }}, llvm-${{ matrix.llvm }}, cuda=${{ matrix.cuda }}, ${{ matrix.lua }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ 'ubuntu-22.04' ]
        llvm: ['12', '13', '14', '15', '16', '17', '18']
        cuda: ['0', '1']
        lua: ['luajit', 'moonjit']
        exclude:
          # CUDA: only LLVM 11
          - llvm: '12'
            cuda: '1'
          - llvm: '13'
            cuda: '1'
          - llvm: '14'
            cuda: '1'
          - llvm: '15'
            cuda: '1'
          - llvm: '16'
            cuda: '1'
          - llvm: '17'
            cuda: '1'
          - llvm: '18'
            cuda: '1'

          # Moonjit: only LLVM 12
          - llvm: '11'
            lua: 'moonjit'
          - llvm: '13'
            lua: 'moonjit'
          - llvm: '14'
            lua: 'moonjit'
          - llvm: '15'
            lua: 'moonjit'
          - llvm: '16'
            lua: 'moonjit'
          - llvm: '17'
            lua: 'moonjit'
          - llvm: '18'
            lua: 'moonjit'
    steps:
      - uses: actions/checkout@v4
      - run: ./travis.sh
        shell: bash
        env:
          LLVM_VERSION: ${{ matrix.llvm }}
          USE_CUDA: ${{ matrix.cuda }}
          STATIC_LLVM: 1
          STATIC_LUAJIT: 1
          SLIB_INCLUDE_LLVM: 1
          SLIB_INCLUDE_LUAJIT: 1
          TERRA_LUA: ${{ matrix.lua }}
      - uses: actions/upload-artifact@v4
        with:
          name: terra-${{ matrix.os }}-x86_64-llvm-${{ matrix.llvm }}
          path: |
            terra-*.tar.xz
            terra-*.7z
