language: cpp
sudo: required
dist: trusty
os:
  - linux
  - osx
compiler:
  - gcc
  - clang
env:
  matrix:
  - LLVM_CONFIG=llvm-config-3.8 CLANG=clang-3.8 USE_CMAKE=1
  - LLVM_CONFIG=llvm-config-3.8 CLANG=clang-3.8 USE_CMAKE=0
  - LLVM_CONFIG=llvm-config-3.5 CLANG=clang-3.5 USE_CMAKE=0

matrix:
  exclude:
    - os: osx
      compiler: gcc
# blacklist some branches
branches:
  only:
    - develop
    - master
before_install:
  - |
    if [[ "$(uname)" = "Linux" ]]; then
      curl -O https://releases.llvm.org/3.8.1/clang+llvm-3.8.1-x86_64-linux-gnu-ubuntu-14.04.tar.xz
      tar xf clang+llvm-3.8.1-x86_64-linux-gnu-ubuntu-14.04.tar.xz
      ln -s clang+llvm-3.8.1-x86_64-linux-gnu-ubuntu-14.04/bin/llvm-config llvm-config-3.8
      ln -s clang+llvm-3.8.1-x86_64-linux-gnu-ubuntu-14.04/bin/clang clang-3.8
      export CMAKE_PREFIX_PATH=$PWD/clang+llvm-3.8.1-x86_64-linux-gnu-ubuntu-14.04

      curl -O https://releases.llvm.org/3.5.2/clang+llvm-3.5.2-x86_64-linux-gnu-ubuntu-14.04.tar.xz
      tar xf clang+llvm-3.5.2-x86_64-linux-gnu-ubuntu-14.04.tar.xz
      ln -s clang+llvm-3.5.2-x86_64-linux-gnu-ubuntu-14.04/bin/llvm-config llvm-config-3.5
      ln -s clang+llvm-3.5.2-x86_64-linux-gnu-ubuntu-14.04/bin/clang clang-3.5
      export PATH=$PWD:$PATH
    fi
  - |
    if [[ "$(uname)" = "Darwin" ]]; then
      curl -O http://releases.llvm.org/3.8.0/clang+llvm-3.8.0-x86_64-apple-darwin.tar.xz
      tar xf clang+llvm-3.8.0-x86_64-apple-darwin.tar.xz
      ln -s clang+llvm-3.8.0-x86_64-apple-darwin/bin/llvm-config llvm-config-3.8
      ln -s clang+llvm-3.8.0-x86_64-apple-darwin/bin/clang clang-3.8
      export CMAKE_PREFIX_PATH=$PWD/clang+llvm-3.8.0-x86_64-apple-darwin

      curl -O http://releases.llvm.org/3.5.2/clang+llvm-3.5.2-x86_64-apple-darwin.tar.xz
      tar xf clang+llvm-3.5.2-x86_64-apple-darwin.tar.xz
      ln -s clang+llvm-3.5.2-x86_64-apple-darwin/bin/llvm-config llvm-config-3.5
      ln -s clang+llvm-3.5.2-x86_64-apple-darwin/bin/clang clang-3.5
      export PATH=$PWD:$PATH
    fi
script:
  - |
    if [[ $USE_CMAKE -eq 1 ]]; then
      (cd build && cmake .. && make install)
      (cd test && ./run)
    else
      make LLVM_CONFIG=$(which $LLVM_CONFIG) CLANG=$(which $CLANG) test
    fi
